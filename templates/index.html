<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <link rel="stylesheet" href="static/css/style.css">
  <link type="image/png" sizes="16x16" rel="icon" href="{{ url_for('static', filename='icons8-buch-ios-17-outlined-16.png') }}">
  <link type="image/png" sizes="32x32" rel="icon" href="{{ url_for('static', filename='icons8-buch-ios-17-outlined-32.png') }}">
  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/tool.js') }}"></script>

  <title>Lerngruppen-Tool</title>
</head>
<body>
<header class="container py-4" style="max-width: 520px;">
  <div class="d-flex align-items-center justify-content-between">
    <h1 class="m-0 fw-bold text-uppercase" style="letter-spacing:.5px;">LERNGRUPPEN</h1>

    <nav aria-label="Profilmenü">
      <div class="dropdown">
        <button
          class="btn p-0 border-0 bg-transparent"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          aria-label="Profilmenü öffnen"
        >
          <span class="rounded-circle d-flex align-items-center justify-content-center"
                style="width:52px;height:52px;background:#E9ECEF;">
            <!-- Platzhalter-Icon -->
            <svg width="28" height="28" viewBox="0 0 24 24" fill="#ADB5BD" aria-hidden="true">
              <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2-8 4v2h16v-2c0-2-3.58-4-8-4Z"/>
            </svg>
          </span>
        </button>

        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
          <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
      </div>
    </nav>
  </div>
</header>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <section class="container flash-wrap" style="max-width:520px;" aria-label="Benachrichtigungen">
      <div class="flash-stack">
        {% for category, message in messages %}
          <div class="alert flash-pill flash-{{ category }} alert-dismissible fade show" role="alert">
            <span class="flash-dot" aria-hidden="true"></span>
            <p class="flash-text m-0">{{ message }}</p>

            <button type="button"
                    class="btn-close flash-close"
                    data-bs-dismiss="alert"
                    aria-label="Schließen"></button>
          </div>
        {% endfor %}
      </div>
    </section>
    <br>
  {% endif %}
{% endwith %}






<main class="container pb-5" style="max-width: 520px;">
  <!-- Suche -->
  <section aria-label="Suche" class="mb-3">
    <form class="row g-2 align-items-center" method="get" action="{{ url_for('index') }}">
      <div class="col">
        <label class="visually-hidden" for="search">Suchen</label>
        <input id="search" name="q" type="search"
               class="form-control form-control-lg rounded-pill"
               placeholder="Suchen.." value="{{ search or '' }}">
      </div>
      <div class="col-auto">
        <button class="btn btn-secondary btn-lg rounded-pill px-4" type="submit">Suchen</button>
      </div>
    </form>
  </section>
  {% if search %}
      <a href="{{ url_for('index') }}" class="small text-muted ms-2">
        Suche zurücksetzen
      </a>
    {% endif %}

  <!-- Meine Gruppen -->
  <section aria-labelledby="my-groups-title" class="mb-4">
    <h2 id="my-groups-title" class="fw-semibold mb-3 all-grp">Meine Gruppen</h2>

    <ul class="list-unstyled vstack gap-3 m-0">
      <!-- ITEMS -->
      {% if my_groups %}
        {% for my_group in my_groups %}
        <li>
            <!-- Klickbare Gruppenzeile -->
            <button
              type="button"
              class="w-100 text-start bg-white border px-3 py-3 d-flex align-items-center justify-content-between
              pill-row pill-shadow {% if group_meta[my_group.id].status == 'past' or group_meta[my_group.id].is_full %}pill-dashed{% endif %} p-1"
              data-bs-toggle="collapse"
              data-bs-target="#my_group{{ my_group.id }}"
              aria-expanded="false"
              aria-controls="my_group{{ my_group.id }}"
            >
              <div class="d-flex flex-column">
                <span class="fw-semibold">{{ my_group.name }}</span>

                {% if my_group.appointment %}
                  <small class="text-muted d-flex align-items-center gap-2">

                    <!-- Datum -->
                    <span>
                      Wann: {{ my_group.appointment | dt_local }}
                    </span>

                    <!-- Status Badge -->
                    {% set status = group_meta[my_group.id].status %}
                    {% if status == "past" %}
                      <span class="badge rounded-pill text-bg-secondary">abgelaufen</span>
                    {% elif status == "today" %}
                      <span class="badge rounded-pill text-bg-warning">heute</span>
                    {% elif status == "future" %}
                      <span class="badge rounded-pill text-bg-info">geplant</span>
                    {% endif %}
                  </small>
                {% endif %}
                <small class="text-muted d-flex align-items-center gap-2">
                  <span>
                    Wo: {{ my_group.place }}
                  </span>
                </small>
              </div>

              <!-- Platzhalter für Mitglieder, falls du das später hast -->
              <span class="text-muted fw-semibold" style="min-width:64px;text-align:right;">
                {{ my_group.grade or "-" }}
              </span>
            </button>

            <!-- Summary -->
            <div id="my_group{{ my_group.id }}" class="collapse">
              <div class="mt-2 px-3">
                <div class="border rounded-4 p-3 bg-body">
                  <p class="mb-2 text-muted grp-name">
                    <strong>Fach:</strong> {{ my_group.subject or "—" }} ·
                    <strong>Stufe:</strong> {{ my_group.grade or "—" }}
                  </p>
                  <p class="mb-3 grp-name">
                    <strong>Thema:</strong> {{ my_group.topic }}
                  </p>

                  <div class="d-flex justify-content-end">

                    <!--IF ADMIN v-->
                    <form method="post"
                      action="{{ url_for('delete_group_route', group_id=my_group.id) }}"
                      onsubmit="return confirm('Möchtest du diese Gruppe wirklich löschen?');"
                      class="m-0">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                      <button type="submit"
                              class="btn btn-outline-danger rounded-pill px-4">
                        Löschen
                      </button>
                    </form>
                    <!--IF ADMIN ^-->
                    <!--vvvvvvv später ersetzen mit group.owner== current_user.id vvvvvvv-->
                  {% if my_group.owner == 1 %}<!-- DAS DA -->
                    <button
                      type="button"
                      class="btn btn-outline-primary rounded-pill px-4"
                      data-bs-toggle="modal"
                      data-bs-target="#editGroupModal"
                      data-group-id="{{ my_group.id }}"
                      data-group-name="{{ my_group.name }}"
                      data-group-grade="{{ my_group.grade or '' }}"
                      data-group-subject="{{ my_group.subject or '' }}"
                      data-group-topic="{{ my_group.topic or '' }}"
                      data-group-appointment="{{ my_group.appointment or '' }}"
                      data-group-place="{{ my_group.place or '' }}"
                    >
                      Bearbeiten
                    </button>
                  {% endif %}
                    <div class="d-flex justify-content-end">
                      <a class="open btn btn-first rounded-pill px-4"
                         href="{{ url_for('group_overview', group_id=my_group.id) }}">
                        Öffnen
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        {% endfor %}
      {% else %}
          <p class="text-muted">Du bist aktuell in keiner Gruppe.</p>
      {% endif %}
    </ul>
  </section>

  <section aria-labelledby="all-groups-title">
    <h2 id="all-groups-title" class="fw-semibold mb-3" style="font-size:1.75rem;">
    Alle Gruppen
    </h2>

    {% if groups %}
      <ul class="list-unstyled vstack gap-3 m-0">
        {% for group in groups %}
          <li>
            <!-- Klickbare Gruppenzeile -->
            <button
              type="button"
              class="w-100 text-start bg-white border px-3 py-3 d-flex align-items-center justify-content-between
              pill-row pill-shadow {% if group_meta[group.id].status == 'past' or group_meta[group.id].is_full %}pill-dashed{% endif %} p-1"
              data-bs-toggle="collapse"
              data-bs-target="#group{{ group.id }}"
              aria-expanded="false"
              aria-controls="group{{ group.id }}"
            >
              <div class="d-flex flex-column">
                <span class="fw-semibold">{{ group.name }}</span>

                {% if group.appointment %}
                  <small class="text-muted d-flex align-items-center gap-2">

                    <!-- Datum -->
                    <span>
                      Wann: {{ group.appointment | dt_local }}
                    </span>

                    <!-- Status Badge -->
                    {% set status = group_meta[group.id].status %}
                    {% if status == "past" %}
                      <span class="badge rounded-pill text-bg-secondary">abgelaufen</span>
                    {% elif status == "today" %}
                      <span class="badge rounded-pill text-bg-warning">heute</span>
                    {% elif status == "future" %}
                      <span class="badge rounded-pill text-bg-info">geplant</span>
                    {% endif %}
                  </small>
                {% endif %}
                <small class="text-muted d-flex align-items-center gap-2">
                  <span>
                    Wo: {{ group.place }}
                  </span>
                </small>
              </div>

              <!-- Platzhalter für Mitglieder, falls du das später hast -->
              <span class="text-muted fw-semibold" style="min-width:64px;text-align:right;">
                {{ group.grade or "-" }}
              </span>
            </button>

            <!-- Summary -->
            <div id="group{{ group.id }}" class="collapse">
              <div class="mt-2 px-3">
                <div class="border rounded-4 p-3 bg-body">
                  <p class="mb-2 text-muted grp-name">
                    <strong>Fach:</strong> {{ group.subject or "—" }} ·
                    <strong>Stufe:</strong> {{ group.grade or "—" }}
                  </p>
                  <p class="mb-3 grp-name">
                    <strong>Thema:</strong> {{ group.topic }}
                  </p>

                  <div class="d-flex justify-content-end">

                    <!--IF ADMIN v-->
                    <form method="post"
                      action="{{ url_for('delete_group_route', group_id=group.id) }}"
                      onsubmit="return confirm('Möchtest du diese Gruppe wirklich löschen?');"
                      class="m-0">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                      <button type="submit"
                              class="btn btn-outline-danger rounded-pill px-4">
                        Löschen
                      </button>
                    </form>
                    <!--IF ADMIN ^-->
                    <!--vvvvvvv später ersetzen mit group.owner== current_user.id vvvvvvv-->
                  {% if group.owner == 1 %}<!-- DAS DA -->
                    <button
                      type="button"
                      class="btn btn-outline-primary rounded-pill px-4"
                      data-bs-toggle="modal"
                      data-bs-target="#editGroupModal"
                      data-group-id="{{ group.id }}"
                      data-group-name="{{ group.name }}"
                      data-group-grade="{{ group.grade or '' }}"
                      data-group-subject="{{ group.subject or '' }}"
                      data-group-topic="{{ group.topic or '' }}"
                      data-group-appointment="{{ group.appointment or '' }}"
                      data-group-place="{{ group.place or '' }}"
                    >
                      Bearbeiten
                    </button>
                  {% endif %}
                    <form method="post" action="{{ url_for('join_group', group_id=group.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button
                        type="submit"
                        class="btn rounded-pill px-4 text-white btn-disabled"
                        {% if group_meta[group.id].status == 'past' or group_meta[group.id].is_full %} disabled aria-disabled="true" {% endif %}
                      >
                        Beitreten
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">Es sind noch keine Gruppen vorhanden.</p>
    {% endif %}

    {% if search %}
      <div class="text-center text-muted py-4">
        Keine Gruppen gefunden{% if search %} für „{{ search }}“{% endif %}.
      </div>
    {% endif %}
    </ul>
  </section>
</main>

<!-- Modal: Gruppe editieren -->
{% include "modals/edit_modal.html" %}

<!-- Modal: Gruppe erstellen -->
{% include "modals/create_modal.html" %}

<!-- Floating Action Button -->
<button
  type="button"
  class="btn-create position-fixed bottom-0 end-0 m-4 d-flex align-items-center justify-content-center text-decoration-none border-0"
  data-bs-toggle="modal"
  data-bs-target="#createGroupModal"
  aria-label="Neue Lerngruppe erstellen"
>
  <span class="plus text-white fw-bold">+</span>
</button>

</body>
</html>